(function(){"use strict";var e={};e.d=function(t,i){for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},e.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},e.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},e.p="bundles/stripeshopwarepayment/",window?.__sw__?.assetPath&&(e.p=window.__sw__.assetPath+"/bundles/stripeshopwarepayment/"),function(){var t={};e.r(t),e.d(t,{default:function(){return o}});let{Component:i,Mixin:s}=Shopware,{object:n,types:r}=Shopware.Utils,a="StripeShopwarePayment.sales-channel-plugin-config";i.register("stripe-plugin-settings",{template:'{% block stripe_payment %}\n    <sw-page>\n        <template #smart-bar-header>\n            <h2>\n                {{ $t(\'sw-settings.index.title\') }}\n                <sw-icon\n                        small\n                        name="regular-chevron-right-xs"\n                />\n                {{ $t(\'stripe-shopware-payment-config-page.smart-bar.title\') }}\n            </h2>\n        </template>\n\n        <template #smart-bar-actions>\n            <sw-button :routerLink="{ name: \'sw.settings.index\' }">\n                {{ $t(\'stripe-shopware-payment-config-page.smart-bar.cancel\') }}\n            </sw-button>\n\n            {% block stripe_shopware_payment__payment_config_page__save_settings_button %}\n                <sw-button-process\n                        variant="primary"\n                        :isLoading="isLoading"\n                        :disabled="isLoading"\n                        :processSuccess="isSaveSuccessful"\n                        @click="saveConfig"\n                >\n                    {{ $t(\'stripe-shopware-payment-config-page.smart-bar.save\') }}\n                </sw-button-process>\n            {% endblock %}\n        </template>\n\n        <template #content>\n            {% block stripe_shopware_payment__payment_config_page__main_content %}\n                <sw-card-view>\n                    {% block stripe_shopware_payment__payment_config_page__above_system_config_card %}\n                    {% endblock %}\n\n                    <sw-system-config\n                            ref="systemConfig"\n                            salesChannelSwitchable\n                            :domain="configDomain"\n                            @config-changed="updateConfig"\n                    />\n\n                    {% block stripe_shopware_payment__payment_config_page__below_system_config_card %}\n                    {% endblock %}\n                </sw-card-view>\n            {% endblock %}\n        </template>\n    </sw-page>\n{% endblock %}\n',mixins:[s.getByName("notification")],inject:["stripeShopwarePaymentWebhookRegistrationService","stripeShopwarePaymentConfigApiService"],data(){return{isLoading:!1,isSaveSuccessful:!1,config:null,configDomain:a,publishableKeyValid:!1,secretKeyValid:!1}},computed:{globalConfig(){return this.$refs.systemConfig.actualConfigData.null||{}}},metaInfo(){return{title:this.$createTitle(this.$t("stripe-shopware-payment-config-page.title"))}},methods:{async saveConfig(){this.isLoading=!0;try{await this.$refs.systemConfig.saveAll(),this.isSaveSuccessful=!0,this.createNotificationSuccess({title:this.$t("stripe-shopware-payment-config-page.controller.titles.success"),message:this.$t("stripe-shopware-payment-config-page.controller.messages.save.success")})}catch(t){this.isSaveSuccessful=!1;let e=t.response&&t.response.data;e||(e=this.$t("stripe-shopware-payment-config-page.controller.messages.unknown-error")),this.createNotificationError({title:this.$t("stripe-shopware-payment-config-page.controller.titles.error"),message:this.$t("stripe-shopware-payment-config-page.controller.messages.save.error",{errorMessage:e})}),this.isLoading=!1;return}if(await this.validateCredentials(),this.secretKeyValid&&this.getConfigValue(this.config,"stripeSecretKey"))try{await Promise.all([this.registerWebhook(),this.updateStripeAccountCountry()])}finally{delete this.$refs.systemConfig.actualConfigData[this.$refs.systemConfig.currentSalesChannelId],await this.$refs.systemConfig.readAll()}this.isLoading=!1},updateConfig(e){this.config=e,this.isSaveSuccessful=!1},async validateCredentials(){let e=this.getConfigValueWithInheritance("stripePublicKey"),t=this.getConfigValueWithInheritance("stripeSecretKey"),i=[];i.push(this.stripeShopwarePaymentConfigApiService.validateSecretKey(t)),e?i.push(this.stripeShopwarePaymentConfigApiService.validatePublishableKey(e)):i.push(!0);try{[this.secretKeyValid,this.publishableKeyValid]=await Promise.all(i)}catch(e){this.createNotificationError({title:this.$t("stripe-shopware-payment-config-page.controller.titles.error"),message:this.$t("stripe-shopware-payment-config-page.controller.messages.credentials.error",{errorMessage:e.message})});return}this.showCredentialsNotification()},async registerWebhook(){try{let e=this.$refs.systemConfig.currentSalesChannelId;switch((await this.stripeShopwarePaymentWebhookRegistrationService.registerWebhook(e)).result){case"created":this.createNotificationSuccess({title:this.$t("stripe-shopware-payment-config-page.controller.titles.success"),message:this.$t("stripe-shopware-payment-config-page.controller.messages.webhook.created")});break;case"updated":this.createNotificationSuccess({title:this.$t("stripe-shopware-payment-config-page.controller.titles.success"),message:this.$t("stripe-shopware-payment-config-page.controller.messages.webhook.updated")});break;case"no_changes":break;default:this.createNotificationError({title:this.$t("stripe-shopware-payment-config-page.controller.titles.error"),message:this.$t("stripe-shopware-payment-config-page.controller.messages.webhook.error",{errorMessage:this.$t("stripe-shopware-payment-config-page.controller.messages.unknown-error")})});return}}catch(t){let e=t.response.data.result;e||(e=this.$t("stripe-shopware-payment-config-page.controller.messages.unknown-error")),this.createNotificationError({title:this.$t("stripe-shopware-payment-config-page.controller.titles.error"),message:this.$t("stripe-shopware-payment-config-page.controller.messages.webhook.error",{errorMessage:e})})}},showCredentialsNotification(){if(this.secretKeyValid&&this.publishableKeyValid)this.createNotificationSuccess({title:this.$t("stripe-shopware-payment-config-page.controller.titles.success"),message:this.$t("stripe-shopware-payment-config-page.controller.messages.credentials.valid")});else{let e=[];this.secretKeyValid||e.push(this.$t("stripe-shopware-payment-config-page.controller.messages.credentials.stripeSecretKey")),this.publishableKeyValid||e.push(this.$t("stripe-shopware-payment-config-page.controller.messages.credentials.stripePublishableKey")),this.createNotificationError({title:this.$t("stripe-shopware-payment-config-page.controller.titles.error"),message:this.$t("stripe-shopware-payment-config-page.controller.messages.credentials.invalid",{invalidFields:e.join(", ")})})}},getConfigValue(e,t){return e[`${a}.${t}`]},getConfigValueWithInheritance(e){return this.getConfigValue(this.config,e)||this.getConfigValue(this.globalConfig,e)},async updateStripeAccountCountry(){let e=this.$refs.systemConfig.currentSalesChannelId;try{await this.stripeShopwarePaymentConfigApiService.updateStripeAccountCountry({salesChannelId:e})}catch(t){let e=t.response.data.errors[0].detail;this.createNotificationError({title:this.$t("stripe-shopware-payment-config-page.controller.titles.error"),message:this.$t("stripe-shopware-payment-config-page.controller.messages.update-account-country.error",{errorMessage:e})})}}}});var o="data:image/svg+xml;base64,PHN2Zw0KICAgICAgICB3aWR0aD0iMjU2Ig0KICAgICAgICBoZWlnaHQ9IjI1NiINCiAgICAgICAgdmlld0JveD0iMCAwIDI1NiAyNTYiDQogICAgICAgIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyINCj4NCiAgICA8ZGVmcz4NCiAgICAgICAgPGxpbmVhckdyYWRpZW50DQogICAgICAgICAgICAgICAgaWQ9ImxpbmVhckdyYWRpZW50Ig0KICAgICAgICAgICAgICAgIHgxPSIxMDAlIg0KICAgICAgICAgICAgICAgIHkxPSI1OC4zNTYlIg0KICAgICAgICAgICAgICAgIHgyPSIwJSINCiAgICAgICAgICAgICAgICB5Mj0iMCUiDQogICAgICAgID4NCiAgICAgICAgICAgIDxzdG9wDQogICAgICAgICAgICAgICAgICAgIHN0b3AtY29sb3I9IiMyNjk3RDQiDQogICAgICAgICAgICAgICAgICAgIG9mZnNldD0iMCUiDQogICAgICAgICAgICAvPg0KICAgICAgICAgICAgPHN0b3ANCiAgICAgICAgICAgICAgICAgICAgc3RvcC1jb2xvcj0iIzIwN0JDQiINCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0PSI1MCUiDQogICAgICAgICAgICAvPg0KICAgICAgICAgICAgPHN0b3ANCiAgICAgICAgICAgICAgICAgICAgc3RvcC1jb2xvcj0iIzIyODVDRSINCiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0PSIxMDAlIg0KICAgICAgICAgICAgLz4NCiAgICAgICAgPC9saW5lYXJHcmFkaWVudD4NCiAgICA8L2RlZnM+DQogICAgPHBhdGgNCiAgICAgICAgICAgIGQ9Ik0yNCwwIEwyMzIsMCBDMjQ1LjI1NDgzNCwtMi40MzQ4NzM1ZS0xNSAyNTYsMTAuNzQ1MTY2IDI1NiwyNCBMMjU2LDIzMiBDMjU2LDI0NS4yNTQ4MzQgMjQ1LjI1NDgzNCwyNTYgMjMyLDI1NiBMMjQsMjU2IEMxMC43NDUxNjYsMjU2IDEuNjIzMjQ5ZS0xNSwyNDUuMjU0ODM0IDAsMjMyIEwwLDI0IEMtMS42MjMyNDllLTE1LDEwLjc0NTE2NiAxMC43NDUxNjYsMi40MzQ4NzM1ZS0xNSAyNCwwIFoiDQogICAgICAgICAgICBzdHlsZT0iZmlsbDp1cmwoI2xpbmVhckdyYWRpZW50KTsgZmlsbC1ydWxlOm5vbnplcm87Ig0KICAgIC8+DQogICAgPHBhdGgNCiAgICAgICAgICAgIGQ9Ik0xMzkuNjg4LDExMSBDMTI2Ljc2MSwxMDYuMjIgMTE5LjY3NywxMDIuNSAxMTkuNjc3LDk2LjY1NyBDMTE5LjY3Nyw5MS42OTcgMTIzLjc1LDg4Ljg2NSAxMzEuMDExLDg4Ljg2NSBDMTQ0LjI5Miw4OC44NjUgMTU3LjkyNyw5NC4wMDEgMTY3LjMxMyw5OC42MDQgTDE3Mi42MjUsNjUuODQ0IEMxNjUuMTg3LDYyLjMwMiAxNDkuOTU4LDU2LjQ1OSAxMjguODg1LDU2LjQ1OSBDMTE0LjAxMSw1Ni40NTkgMTAxLjYxNSw2MC4zNTQgOTIuNzYxLDY3LjYxNSBDODMuNTUxLDc1LjIyOSA3OC43NzEsODYuMjA5IDc4Ljc3MSw5OS40OSBDNzguNzcxLDEyMy41NzMgOTMuNDY5LDEzMy44NDQgMTE3LjM3NSwxNDIuNTIxIEMxMzIuNzgxLDE0OC4wMTEgMTM3LjkxNywxNTEuOTA3IDEzNy45MTcsMTU3LjkyNyBDMTM3LjkxNywxNjMuNzcxIDEzMi45NTcsMTY3LjEzNSAxMjMuOTI3LDE2Ny4xMzUgQzExMi43NywxNjcuMTM1IDk0LjM1NSwxNjEuNjQ2IDgyLjMxMiwxNTQuNTYzIEw3NywxODcuNjc3IEM4Ny4yNywxOTMuNTIxIDEwNi4zOTUsMTk5LjU0MSAxMjYuMjMsMTk5LjU0MSBDMTQxLjk5LDE5OS41NDEgMTU1LjA5NCwxOTUuODIzIDE2My45NDgsMTg4Ljc0IEMxNzMuODY0LDE4MC45NDggMTc5LDE2OS40MzggMTc5LDE1NC41NjMgQzE3OSwxMjkuOTQ4IDE2My45NDgsMTE5LjY3NyAxMzkuNjg3LDExMS4wMDEgTDEzOS42ODgsMTExIFoiDQogICAgICAgICAgICBzdHlsZT0iZmlsbDojRkZGRkZGOyBmaWxsLXJ1bGU6ZXZlbm9kZDsiDQogICAgLz4NCjwvc3ZnPg0K";let{Component:g}=Shopware;g.register("stripe-settings-icon",{template:'{% block stripe_settings_icon %}\n    <svg\n            width="256"\n            height="256"\n            viewBox="0 0 256 256"\n            xmlns="http://www.w3.org/2000/svg"\n    >\n        <defs>\n            <linearGradient\n                    id="linearGradient"\n                    x1="100%"\n                    y1="58.356%"\n                    x2="0%"\n                    y2="0%"\n            >\n                <stop\n                        stop-color="#2697D4"\n                        offset="0%"\n                />\n                <stop\n                        stop-color="#207BCB"\n                        offset="50%"\n                />\n                <stop\n                        stop-color="#2285CE"\n                        offset="100%"\n                />\n            </linearGradient>\n        </defs>\n        <path\n                d="M24,0 L232,0 C245.254834,-2.4348735e-15 256,10.745166 256,24 L256,232 C256,245.254834 245.254834,256 232,256 L24,256 C10.745166,256 1.623249e-15,245.254834 0,232 L0,24 C-1.623249e-15,10.745166 10.745166,2.4348735e-15 24,0 Z"\n                style="fill:url(#linearGradient); fill-rule:nonzero;"\n        />\n        <path\n                d="M139.688,111 C126.761,106.22 119.677,102.5 119.677,96.657 C119.677,91.697 123.75,88.865 131.011,88.865 C144.292,88.865 157.927,94.001 167.313,98.604 L172.625,65.844 C165.187,62.302 149.958,56.459 128.885,56.459 C114.011,56.459 101.615,60.354 92.761,67.615 C83.551,75.229 78.771,86.209 78.771,99.49 C78.771,123.573 93.469,133.844 117.375,142.521 C132.781,148.011 137.917,151.907 137.917,157.927 C137.917,163.771 132.957,167.135 123.927,167.135 C112.77,167.135 94.355,161.646 82.312,154.563 L77,187.677 C87.27,193.521 106.395,199.541 126.23,199.541 C141.99,199.541 155.094,195.823 163.948,188.74 C173.864,180.948 179,169.438 179,154.563 C179,129.948 163.948,119.677 139.687,111.001 L139.688,111 Z"\n                style="fill:#FFFFFF; fill-rule:evenodd;"\n        />\n    </svg>\n\n{% endblock %}\n',data(){return{svgData:t}},computed:{assetFilter(){return Shopware.Filter.getByName("asset")}}}),g.override("sw-icon",{watch:{name:{async handler(e){0===e.indexOf("stripe-shopware-payment-icon")&&((await this.$nextTick(),"stripe-shopware-payment-icon-plugin"===e)?this.iconSvgData=t:this.iconSvgData="")},immediate:!0}}});let{Module:c}=Shopware;c.register("stripe-settings",{name:"stripe-settings",type:"plugin",color:"#9AA8B5",title:"stripe-shopware-payment-config-module",iconComponent:"stripe-settings-icon",routeMiddleware(e,t){e(t)},routes:{view:{component:"stripe-plugin-settings",path:"view",meta:{parentPath:"sw.settings.index"}}},settingsItem:{group:"plugins",to:"stripe.settings.view",backgroundEnabled:!1,iconComponent:"stripe-settings-icon",label:"stripe-shopware-payment-config-module.stripe-shopware-payment"},snippets:{"de-DE":{"stripe-shopware-payment-config-module":{"stripe-shopware-payment":"Stripe"}},"en-GB":{"stripe-shopware-payment-config-module":{"stripe-shopware-payment":"Stripe"}}}});var p="https://js.stripe.com/v3",l=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,h=function(){for(var e=document.querySelectorAll('script[src^="'.concat(p,'"]')),t=0;t<e.length;t++){var i=e[t];if(l.test(i.src))return i}return null},C=function(e){var t=e&&!e.advancedFraudSignals?"?advancedFraudSignals=false":"",i=document.createElement("script");i.src="".concat(p).concat(t);var s=document.head||document.body;if(!s)throw Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return s.appendChild(i),i},u=function(e,t){e&&e._registerWrapper&&e._registerWrapper({name:"stripe-js",version:"1.54.2",startTime:t})},I=null,d=function(e,t,i){if(null===e)return null;var s=e.apply(void 0,t);return u(s,i),s},y=Promise.resolve().then(function(){return null!==I?I:I=new Promise(function(e,t){if("undefined"==typeof window||"undefined"==typeof document){e(null);return}if(window.Stripe,window.Stripe){e(window.Stripe);return}try{var i=h();i||(i=C(null)),i.addEventListener("load",function(){window.Stripe?e(window.Stripe):t(Error("Stripe.js not available"))}),i.addEventListener("error",function(){t(Error("Failed to load Stripe.js"))})}catch(e){t(e);return}})}),w=!1;y.catch(function(e){w||console.warn(e)});var m=function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];w=!0;var s=Date.now();return y.then(function(e){return d(e,t,s)})};let A=Shopware.Classes.ApiService;var f=class extends A{constructor(e,t){super(e,t,"stripe-payment")}async validateSecretKey(e){let t=this.getBasicHeaders(),i=await this.httpClient.post(`_action/${this.getApiBasePath()}/validate-secret-key`,{stripeSecretKey:e},{headers:t});return A.handleResponse(i)}async validatePublishableKey(e){let t=await m(e);try{return!!(await t.createToken("pii",{personal_id_number:"test"})).token}catch(e){return!1}}async updateStripeAccountCountry({salesChannelId:e}){let t=this.getBasicHeaders(),i=await this.httpClient.post(`_action/${this.getApiBasePath()}/update-stripe-account-country`,{salesChannelId:e},{headers:t});return A.handleResponse(i)}};let M=Shopware.Classes.ApiService;var N=class extends M{constructor(e,t){super(e,t,"stripe-payment")}async registerWebhook(e){let t=this.getBasicHeaders(),i=await this.httpClient.put(`_action/${this.getApiBasePath()}/register-webhook`,{salesChannelId:e},{headers:t});return M.handleResponse(i)}};let{Application:S}=Shopware;S.addServiceProvider("stripeShopwarePaymentWebhookRegistrationService",e=>new N(S.getContainer("init").httpClient,e.loginService)),S.addServiceProvider("stripeShopwarePaymentConfigApiService",e=>new f(S.getContainer("init").httpClient,e.loginService))}()})();